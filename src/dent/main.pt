from    argparse  import Namespace
from    pathlib   import Path

from    dent.config  import Config
from    dent.main  import *

def config(**kv) -> Config:
    ns = Namespace(**kv)
    print(f'using {ns}')
    return Config(ns)

def test_dockerfile():
    c = config(base_image = 'test_dockerfile')
    s = dockerfile(c)
    assert  'FROM test_dockerfile\n' in s \
       and  'RUN true\n' in s \
       and f'USER {c.pwent.pw_name}\n' in s

def test_setup_pkg():
    s = setup_pkg(config())
    assert '#!/usr/bin/env bash' in s \
       and 'packages()' in s

def test_setup_user():
    s = setup_user(config(base_image = 'test_setup_user'))
    assert '#!/usr/bin/env bash' in s \
       and 'users_generic' in s
    #   XXX We should test case where config.image_conf('useradd') is not None.


def test_share_args():
    home = str(Path.home())
    ps = share_args(['/etc/foo', '/home/bar/baz', 'quux'], 'rw')
    assert [    '-v=/etc/foo:/etc/foo:rw',
                '-v=/home/bar/baz:/home/bar/baz:rw',
               f'-v={home}/quux:{home}/quux:rw',
           ] == ps
